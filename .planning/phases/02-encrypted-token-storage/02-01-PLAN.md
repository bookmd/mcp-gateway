---
phase: 02-encrypted-token-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/kms-encryption.ts
  - src/storage/dynamodb-session-store.ts
  - src/storage/types.ts
  - src/config/aws.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Session data can be encrypted with unique data key per session"
    - "Encrypted session data can be decrypted with stored encrypted key"
    - "Session store can save sessions to DynamoDB"
    - "Session store can retrieve sessions from DynamoDB"
    - "Session store filters expired sessions (TTL check)"
  artifacts:
    - path: "src/storage/kms-encryption.ts"
      provides: "Envelope encryption using KMS + AES-256-GCM"
      exports: ["encryptSessionData", "decryptSessionData"]
    - path: "src/storage/dynamodb-session-store.ts"
      provides: "Custom Fastify session store backed by DynamoDB"
      exports: ["DynamoDBSessionStore"]
    - path: "src/storage/types.ts"
      provides: "TypeScript types for encrypted session storage"
      exports: ["EncryptedSessionRecord", "SessionStoreConfig"]
    - path: "src/config/aws.ts"
      provides: "AWS client configuration and shared instances"
      exports: ["kmsClient", "docClient", "KMS_KEY_ARN", "SESSIONS_TABLE"]
  key_links:
    - from: "src/storage/dynamodb-session-store.ts"
      to: "src/storage/kms-encryption.ts"
      via: "import { encryptSessionData, decryptSessionData }"
      pattern: "import.*kms-encryption"
    - from: "src/storage/dynamodb-session-store.ts"
      to: "src/config/aws.ts"
      via: "import { docClient, SESSIONS_TABLE }"
      pattern: "import.*aws"
    - from: "src/storage/kms-encryption.ts"
      to: "src/config/aws.ts"
      via: "import { kmsClient, KMS_KEY_ARN }"
      pattern: "import.*aws"
---

<objective>
Build the encrypted session storage layer: KMS envelope encryption module and DynamoDB session store.

Purpose: Create the core infrastructure for AUTH-03 (encrypted token storage). This plan establishes the storage layer that Plan 02-02 will integrate with Fastify.

Output: Two modules - KMS encryption utilities and DynamoDB session store - ready to replace in-memory session storage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-encrypted-token-storage/02-RESEARCH.md

# Phase 1 established patterns
@src/config/session.ts
@src/server.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: AWS Configuration and Dependencies</name>
  <files>
    - src/config/aws.ts
    - src/storage/types.ts
    - package.json
  </files>
  <action>
1. Install AWS SDK dependencies:
   ```bash
   npm install @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb @aws-sdk/client-kms
   npm install --save-dev @types/express-session
   ```

2. Create `src/config/aws.ts` with shared AWS clients (created once at module scope, reused):
   - KMSClient configured for us-east-1 region
   - DynamoDBDocumentClient (from DynamoDBClient)
   - Export KMS_KEY_ARN constant: `arn:aws:kms:us-east-1:232282424912:key/afd7365b-7a3a-4ae6-97a6-3dcd0ec9a94a`
   - Export SESSIONS_TABLE constant: `mcp-gateway-sessions`
   - Both constants should also support env var override for flexibility

3. Create `src/storage/types.ts` with TypeScript types:
   - `EncryptedSessionRecord`: sessionId, encryptedData, encryptedKey, iv, authTag, ttl, version
   - `SessionStoreConfig`: tableName, ttlSeconds, kmsKeyArn
   - `EncryptionResult`: encryptedData, encryptedKey, iv, authTag (all base64 strings)

Key decisions from research:
- Create clients once at module scope (Pitfall 6 - avoid per-request client creation)
- Include `version: 1` field for future encryption scheme migrations
- Use environment variable fallbacks for local development flexibility
  </action>
  <verify>
- `npm ls @aws-sdk/client-kms @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb` shows all installed
- `npx tsc --noEmit` passes (TypeScript compilation succeeds)
- `src/config/aws.ts` and `src/storage/types.ts` exist with correct exports
  </verify>
  <done>
AWS SDK packages installed. AWS clients configured for KMS and DynamoDB. Storage types defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: KMS Envelope Encryption Module</name>
  <files>
    - src/storage/kms-encryption.ts
  </files>
  <action>
Create `src/storage/kms-encryption.ts` implementing envelope encryption:

1. **encryptSessionData(sessionData: string): Promise<EncryptionResult>**
   - Use GenerateDataKeyCommand with KeySpec: 'AES_256' to get plaintext key + encrypted key
   - Generate unique 12-byte IV using crypto.randomBytes(12)
   - Encrypt data with AES-256-GCM using crypto.createCipheriv
   - Extract authentication tag with cipher.getAuthTag()
   - Return all components as base64 strings
   - CRITICAL: Never log plaintext key, never store it (Pitfall 5)

2. **decryptSessionData(encryptedData, encryptedKey, iv, authTag): Promise<string>**
   - Use DecryptCommand to recover plaintext key from encrypted key
   - Create decipher with AES-256-GCM
   - Set auth tag with decipher.setAuthTag() BEFORE decrypting (GCM requirement)
   - Decrypt and return original session data

Implementation notes from research:
- Import kmsClient and KMS_KEY_ARN from aws.ts
- Use Node.js crypto module (built-in, no external dependency)
- GCM IV must be exactly 12 bytes
- Buffer.from(x, 'base64') for decoding, buffer.toString('base64') for encoding
- Wrap KMS calls in try/catch with meaningful error messages
  </action>
  <verify>
- `npx tsc --noEmit` passes
- File exports encryptSessionData and decryptSessionData functions
- Code uses GenerateDataKeyCommand (not direct Encrypt) for envelope encryption pattern
  </verify>
  <done>
KMS envelope encryption module complete. Can encrypt session data with unique DEK per session and decrypt using stored encrypted key.
  </done>
</task>

<task type="auto">
  <name>Task 3: DynamoDB Session Store</name>
  <files>
    - src/storage/dynamodb-session-store.ts
  </files>
  <action>
Create `src/storage/dynamodb-session-store.ts` implementing express-session store interface:

1. **Class DynamoDBSessionStore**
   Constructor:
   - Accept SessionStoreConfig (tableName, ttlSeconds default 604800 = 7 days)
   - Import docClient and SESSIONS_TABLE from aws.ts

2. **get(sessionId: string, callback: (err: any, session?: any) => void): void**
   - Use GetCommand with ConsistentRead: true (Pitfall 4 - avoid stale reads)
   - Filter expired sessions: check `ttl > Math.floor(Date.now() / 1000)` (Pitfall 2 - DynamoDB TTL lag)
   - If valid session found, decrypt using decryptSessionData
   - Parse decrypted JSON and return via callback
   - Return null for missing/expired sessions (not error)

3. **set(sessionId: string, session: any, callback: (err?: any) => void): void**
   - Serialize session to JSON
   - Encrypt using encryptSessionData
   - Calculate TTL: `Math.floor(Date.now() / 1000) + ttlSeconds`
   - Use PutCommand to store: sessionId, encryptedData, encryptedKey, iv, authTag, ttl, version: 1
   - Call callback() on success, callback(error) on failure

4. **destroy(sessionId: string, callback: (err?: any) => void): void**
   - Use DeleteCommand with sessionId key
   - Call callback regardless of whether item existed

Implementation notes:
- Methods must be async but signature uses callbacks (express-session interface)
- Handle both callback and promise patterns internally
- Import encryptSessionData, decryptSessionData from kms-encryption.ts
- Log errors at warn level, not error (failed session reads are expected for expired)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Class exports DynamoDBSessionStore
- Class implements get, set, destroy methods with callback signatures
- Code uses ConsistentRead: true in GetCommand
- Code checks TTL in application code (not relying solely on DynamoDB TTL)
  </verify>
  <done>
DynamoDB session store complete. Implements express-session interface with encrypted storage and TTL filtering.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. All files exist with correct exports:
   - `src/config/aws.ts` exports kmsClient, docClient, KMS_KEY_ARN, SESSIONS_TABLE
   - `src/storage/types.ts` exports EncryptedSessionRecord, SessionStoreConfig, EncryptionResult
   - `src/storage/kms-encryption.ts` exports encryptSessionData, decryptSessionData
   - `src/storage/dynamodb-session-store.ts` exports DynamoDBSessionStore class
3. No hardcoded credentials in any file (uses AWS SDK default credential chain)
4. Console.log does not appear in encryption code (no plaintext key logging)
</verification>

<success_criteria>
- Storage layer modules created and TypeScript-valid
- Envelope encryption pattern implemented (GenerateDataKey, not direct Encrypt)
- Session store implements express-session interface (get/set/destroy callbacks)
- TTL filtering in application code (not relying on DynamoDB TTL alone)
- Ready for integration in Plan 02-02
</success_criteria>

<output>
After completion, create `.planning/phases/02-encrypted-token-storage/02-01-SUMMARY.md`
</output>
