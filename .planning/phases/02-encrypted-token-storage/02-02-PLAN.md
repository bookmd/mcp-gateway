---
phase: 02-encrypted-token-storage
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/config/session.ts
  - src/server.ts
  - .env.example
autonomous: false

user_setup:
  - service: aws
    why: "DynamoDB and KMS access for encrypted session storage"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "AWS IAM Console -> Users -> Security credentials -> Create access key"
      - name: AWS_SECRET_ACCESS_KEY
        source: "AWS IAM Console -> Users -> Security credentials -> Create access key"
      - name: AWS_REGION
        source: "Set to us-east-1 (where DynamoDB table and KMS key were created)"
    dashboard_config: []

must_haves:
  truths:
    - "User session persists across server restart"
    - "OAuth tokens are encrypted before storage"
    - "Sessions expire after 7 days"
    - "Authenticated user can reconnect without re-authenticating (within 7 days)"
  artifacts:
    - path: "src/config/session.ts"
      provides: "Session configuration with DynamoDB store"
      exports: ["sessionConfig", "sessionStore"]
    - path: "src/server.ts"
      provides: "Fastify app using DynamoDB session store"
      contains: "store: sessionStore"
    - path: ".env.example"
      provides: "Environment variable documentation"
      contains: "AWS_REGION"
  key_links:
    - from: "src/server.ts"
      to: "src/config/session.ts"
      via: "import { sessionStore }"
      pattern: "store.*sessionStore"
    - from: "src/config/session.ts"
      to: "src/storage/dynamodb-session-store.ts"
      via: "import { DynamoDBSessionStore }"
      pattern: "new DynamoDBSessionStore"
---

<objective>
Integrate DynamoDB session store with Fastify and verify end-to-end encrypted persistence.

Purpose: Complete AUTH-03 by wiring the storage layer from Plan 02-01 into the application. Verify sessions persist across server restarts with encryption.

Output: Working encrypted session storage with persistence verification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-encrypted-token-storage/02-RESEARCH.md
@.planning/phases/02-encrypted-token-storage/02-01-SUMMARY.md

# Files to modify
@src/config/session.ts
@src/server.ts

# Storage modules from Plan 02-01
@src/storage/dynamodb-session-store.ts
@src/storage/kms-encryption.ts
@src/config/aws.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire DynamoDB Store to Fastify Session</name>
  <files>
    - src/config/session.ts
    - src/server.ts
    - .env.example
  </files>
  <action>
1. Update `src/config/session.ts`:
   - Import DynamoDBSessionStore from storage/dynamodb-session-store.ts
   - Import SESSIONS_TABLE from config/aws.ts
   - Create and export sessionStore instance:
     ```typescript
     export const sessionStore = new DynamoDBSessionStore({
       tableName: SESSIONS_TABLE,
       ttlSeconds: 7 * 24 * 60 * 60 // 7 days (AUTH-04 weekly expiration)
     });
     ```
   - Keep existing sessionConfig export unchanged

2. Update `src/server.ts`:
   - Import sessionStore from config/session.ts
   - Add store option to fastifySession registration:
     ```typescript
     await app.register(fastifySession, {
       secret: sessionConfig.secret,
       cookie: sessionConfig.cookie,
       store: sessionStore,
       saveUninitialized: false
     });
     ```

3. Create or update `.env.example` with AWS configuration:
   ```
   # Existing
   SESSION_SECRET=your-32-character-minimum-secret-here
   GOOGLE_CLIENT_ID=your-google-client-id
   GOOGLE_CLIENT_SECRET=your-google-client-secret

   # AWS Configuration (Phase 2)
   AWS_REGION=us-east-1
   AWS_ACCESS_KEY_ID=your-aws-access-key
   AWS_SECRET_ACCESS_KEY=your-aws-secret-key
   ```

Note: AWS SDK v3 automatically reads AWS_* environment variables via default credential chain. No code changes needed for credential loading.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `src/config/session.ts` exports sessionStore
- `src/server.ts` includes `store: sessionStore` in session config
- `.env.example` documents all required environment variables
  </verify>
  <done>
DynamoDB session store wired into Fastify. Server uses encrypted persistent storage instead of in-memory.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-End Persistence Verification</name>
  <what-built>
Encrypted session storage with DynamoDB persistence. Sessions should survive server restart.
  </what-built>
  <how-to-verify>
**Pre-requisites:**
- Ensure AWS credentials are configured in .env (AWS_REGION, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
- DynamoDB table `mcp-gateway-sessions` must exist in us-east-1
- KMS key must be accessible

**Test 1: Basic Session Persistence**
1. Start server: `npm run dev`
2. Open browser: `http://localhost:3000/auth/login`
3. Complete Google OAuth flow (use @getvim.com account)
4. After redirect, visit `http://localhost:3000/protected`
5. Note the response (should show email and sessionId)
6. **Stop the server** (Ctrl+C)
7. **Start the server again**: `npm run dev`
8. Visit `http://localhost:3000/protected` again (same browser, same session cookie)
9. **Expected:** Still authenticated, same email shown

**Test 2: Verify Encryption in DynamoDB**
1. Open AWS Console -> DynamoDB -> Tables -> mcp-gateway-sessions
2. Click "Explore table items"
3. Find the session record (recent item)
4. **Expected:**
   - `encryptedData` field is base64 gibberish (not readable JSON)
   - `encryptedKey` field is base64 (encrypted DEK)
   - `iv` and `authTag` fields are present
   - `ttl` field is Unix timestamp ~7 days in future
   - `version` field is 1

**Test 3: SSE Reconnection After Restart**
1. With server running and authenticated in browser
2. Open new terminal: `curl http://localhost:3000/mcp/status -b <your-session-cookie>`
   (Or check /mcp/status in browser while authenticated)
3. **Stop server**, wait 5 seconds, **start server**
4. Check /mcp/status again
5. **Expected:** Still shows authenticated user info (session persisted)

**Failure indicators:**
- 401 error after server restart = session not persisted
- Readable JSON in DynamoDB = encryption not working
- Missing ttl/version fields = store not writing correctly
- KMS errors in server logs = credential or key issues
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe the specific failure</resume-signal>
</task>

</tasks>

<verification>
Phase 2 complete when:
1. Sessions persist across server restarts (user stays logged in)
2. DynamoDB shows encrypted data (not readable plaintext)
3. TTL is set correctly (~7 days from creation)
4. No plaintext tokens visible in logs or database
5. All Phase 2 success criteria met:
   - OAuth tokens encrypted with KMS before DynamoDB write
   - Gateway retrieves and decrypts stored tokens on subsequent connections
   - User maintains authenticated session across gateway restarts
   - Tokens automatically expire from DynamoDB after 7 days
</verification>

<success_criteria>
- AUTH-03 requirement complete: OAuth tokens stored encrypted in DynamoDB with KMS
- Server restart does not log out authenticated users
- DynamoDB records show encrypted (unreadable) token data
- 7-day TTL applied to all session records
- End-to-end OAuth -> persist -> restart -> reconnect flow verified
</success_criteria>

<output>
After completion, create `.planning/phases/02-encrypted-token-storage/02-02-SUMMARY.md`

Update STATE.md with:
- Phase 2 complete
- AUTH-03 requirement met
- Overall progress: 6/17 requirements (35%)
</output>
