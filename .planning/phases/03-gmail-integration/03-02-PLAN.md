---
phase: 03-gmail-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/gmail/client.ts
  - src/gmail/parsers.ts
autonomous: true

must_haves:
  truths:
    - "Gmail client can be created from UserContext access token"
    - "Gmail API messages can be parsed into structured format"
    - "Message body (plain text and HTML) extracted correctly"
    - "Attachments metadata parsed without downloading content"
  artifacts:
    - path: "src/gmail/client.ts"
      provides: "Gmail API client factory from UserContext"
      exports: ["createGmailClient"]
      min_lines: 20
    - path: "src/gmail/parsers.ts"
      provides: "Gmail message parsing utilities"
      exports: ["parseMessageSummary", "parseFullMessage"]
      min_lines: 40
  key_links:
    - from: "src/gmail/client.ts"
      to: "googleapis"
      via: "google.auth.OAuth2 and google.gmail"
      pattern: "google\\.gmail.*auth"
    - from: "src/gmail/parsers.ts"
      to: "gmail-api-parse-message"
      via: "parseMessage import"
      pattern: "gmail-api-parse-message"
---

<objective>
Create Gmail client factory and message parsing utilities for MCP tool handlers.

Purpose: Provide reusable modules for Gmail API authentication and message body parsing that will be used by all Gmail MCP tools.

Output: Gmail client factory (creates per-user authenticated client) and message parser (converts Gmail API responses to our TypeScript types).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gmail-integration/03-RESEARCH.md
@.planning/phases/03-gmail-integration/03-01-SUMMARY.md

# Relevant source files
@src/auth/middleware.ts
@src/gmail/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gmail Client Factory</name>
  <files>src/gmail/client.ts</files>
  <action>
Create `src/gmail/client.ts` with a factory function that creates authenticated Gmail API clients from UserContext:

```typescript
/**
 * Gmail API client factory
 * Creates per-user authenticated Gmail clients using access tokens from UserContext
 */
import { google, gmail_v1 } from 'googleapis';
import type { UserContext } from '../auth/middleware.js';

/**
 * Create an authenticated Gmail API client for a specific user
 *
 * @param userContext - User context containing OAuth access token
 * @returns Authenticated Gmail API client instance
 *
 * @example
 * const gmail = createGmailClient(userContext);
 * const messages = await gmail.users.messages.list({ userId: 'me' });
 */
export function createGmailClient(userContext: UserContext): gmail_v1.Gmail {
  const oauth2Client = new google.auth.OAuth2(
    process.env.GOOGLE_CLIENT_ID,
    process.env.GOOGLE_CLIENT_SECRET,
    process.env.GOOGLE_REDIRECT_URI
  );

  oauth2Client.setCredentials({
    access_token: userContext.accessToken
  });

  return google.gmail({ version: 'v1', auth: oauth2Client });
}
```

**Important patterns from RESEARCH.md:**
- Create OAuth2Client instance per request (not global) - each user has different access token
- Use `setCredentials()` with access_token only (no refresh_token - weekly re-auth policy AUTH-04)
- Return typed `gmail_v1.Gmail` for full TypeScript support
- Environment variables for OAuth config (same as existing oauth-client.ts)
  </action>
  <verify>
1. `ls src/gmail/client.ts` confirms file exists
2. `grep "createGmailClient" src/gmail/client.ts` shows export
3. `grep "google.auth.OAuth2" src/gmail/client.ts` shows OAuth2Client usage
4. `npm run build` compiles without TypeScript errors
  </verify>
  <done>
src/gmail/client.ts exports createGmailClient() function that creates authenticated Gmail API clients from UserContext. Uses OAuth2Client with per-user access tokens.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Message Parser Utilities</name>
  <files>src/gmail/parsers.ts</files>
  <action>
Create `src/gmail/parsers.ts` with functions to parse Gmail API responses into our TypeScript types:

```typescript
/**
 * Gmail message parsing utilities
 * Converts Gmail API responses to our typed interfaces
 */
import parseMessage from 'gmail-api-parse-message';
import type { gmail_v1 } from 'googleapis';
import type {
  GmailMessageSummary,
  GmailMessage,
  GmailAttachment
} from './types.js';

/**
 * Extract a header value from Gmail message headers
 */
function getHeader(
  headers: gmail_v1.Schema$MessagePartHeader[] | undefined,
  name: string
): string {
  return headers?.find(h => h.name?.toLowerCase() === name.toLowerCase())?.value || '';
}

/**
 * Parse a Gmail message into a summary (for list/search results)
 * Uses headers only - no body content
 */
export function parseMessageSummary(
  message: gmail_v1.Schema$Message
): GmailMessageSummary {
  const headers = message.payload?.headers;

  return {
    id: message.id || '',
    threadId: message.threadId || '',
    subject: getHeader(headers, 'Subject'),
    from: getHeader(headers, 'From'),
    to: getHeader(headers, 'To'),
    date: getHeader(headers, 'Date'),
    snippet: message.snippet || '',
    labelIds: message.labelIds || []
  };
}

/**
 * Parse a Gmail message into full content (for get operations)
 * Uses gmail-api-parse-message library for body extraction
 */
export function parseFullMessage(
  message: gmail_v1.Schema$Message
): GmailMessage {
  // Get summary fields first
  const summary = parseMessageSummary(message);

  // Use library to parse complex MIME structure
  // This handles multipart/alternative, multipart/mixed, base64url decoding
  const parsed = parseMessage(message);

  // Extract attachments metadata (not content - too large)
  const attachments: GmailAttachment[] = (parsed.attachments || []).map(att => ({
    filename: att.filename || 'unnamed',
    mimeType: att.mimeType || 'application/octet-stream',
    size: att.size || 0,
    attachmentId: att.attachmentId || ''
  }));

  return {
    ...summary,
    textBody: parsed.textPlain || null,
    htmlBody: parsed.textHtml || null,
    attachments
  };
}
```

**Important patterns from RESEARCH.md:**
- Use gmail-api-parse-message for body parsing (handles complex MIME structures)
- Library handles base64url decoding automatically
- Extract headers manually for summary (faster than full parse)
- Attachments include metadata only (attachmentId for later download if needed)
- Handle null/undefined gracefully - Gmail API responses can be sparse
  </action>
  <verify>
1. `ls src/gmail/parsers.ts` confirms file exists
2. `grep "parseMessageSummary" src/gmail/parsers.ts` shows export
3. `grep "parseFullMessage" src/gmail/parsers.ts` shows export
4. `grep "gmail-api-parse-message" src/gmail/parsers.ts` shows library import
5. `npm run build` compiles without TypeScript errors
  </verify>
  <done>
src/gmail/parsers.ts exports parseMessageSummary() and parseFullMessage() functions. Uses gmail-api-parse-message library for body extraction. Handles complex MIME structures and base64url decoding.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Client factory exists:
   ```bash
   grep -n "export function createGmailClient" src/gmail/client.ts
   ```
   Expected: Function export on line ~15-20

2. Parser exports:
   ```bash
   grep "export function" src/gmail/parsers.ts
   ```
   Expected: parseMessageSummary and parseFullMessage exports

3. Library usage:
   ```bash
   grep "gmail-api-parse-message" src/gmail/parsers.ts
   ```
   Expected: Import statement present

4. Build succeeds:
   ```bash
   npm run build
   ```
   Expected: No TypeScript errors, dist/gmail/client.js and dist/gmail/parsers.js created

5. Gmail module structure:
   ```bash
   ls -la src/gmail/
   ```
   Expected: types.ts, client.ts, parsers.ts all exist
</verification>

<success_criteria>
- src/gmail/client.ts exports createGmailClient(userContext) function
- createGmailClient returns gmail_v1.Gmail typed client
- src/gmail/parsers.ts exports parseMessageSummary and parseFullMessage
- Parsers use gmail-api-parse-message library for body extraction
- All files compile without TypeScript errors
- Gmail module has 3 files: types.ts, client.ts, parsers.ts
</success_criteria>

<output>
After completion, create `.planning/phases/03-gmail-integration/03-02-SUMMARY.md`
</output>
