---
phase: 03-gmail-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth/oauth-client.ts
  - package.json
  - src/gmail/types.ts
autonomous: true

must_haves:
  truths:
    - "OAuth flow requests gmail.readonly scope"
    - "googleapis package installed and importable"
    - "gmail-api-parse-message package installed and importable"
    - "Gmail TypeScript types defined for MCP tool responses"
  artifacts:
    - path: "src/auth/oauth-client.ts"
      provides: "OAuth scope with gmail.readonly"
      contains: "gmail.readonly"
    - path: "src/gmail/types.ts"
      provides: "Gmail response types for MCP tools"
      exports: ["GmailSearchResult", "GmailMessage", "GmailMessageSummary"]
    - path: "package.json"
      provides: "Gmail dependencies"
      contains: "googleapis"
  key_links:
    - from: "src/auth/oauth-client.ts"
      to: "Google OAuth"
      via: "scope parameter in authorizationUrl"
      pattern: "gmail\\.readonly"
---

<objective>
Add Gmail API scope to OAuth flow and install required dependencies for Gmail integration.

Purpose: Enable authenticated users to access Gmail API by expanding OAuth permissions and adding the googleapis client library.

Output: Updated OAuth scope, installed dependencies (googleapis, gmail-api-parse-message), and Gmail TypeScript types for MCP tool responses.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gmail-integration/03-RESEARCH.md

# Relevant source files
@src/auth/oauth-client.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Gmail Scope and Install Dependencies</name>
  <files>src/auth/oauth-client.ts, package.json</files>
  <action>
1. Update `src/auth/oauth-client.ts` createAuthUrl() function:
   - Change scope from `'openid email profile'` to `'openid email profile https://www.googleapis.com/auth/gmail.readonly'`
   - The scope string must include the full URL for gmail.readonly

2. Install Gmail dependencies:
   ```bash
   npm install googleapis gmail-api-parse-message
   ```

3. Verify TypeScript recognizes the packages (no install errors, packages appear in node_modules).

**Note:** Existing authenticated users will need to re-authenticate to gain the new Gmail scope. This is expected behavior - the OAuth callback error handling will direct them to re-login.

**Warning:** Do NOT use granular scopes like gmail.labels or gmail.metadata - gmail.readonly is required for full message access per RESEARCH.md.
  </action>
  <verify>
1. `grep -n "gmail.readonly" src/auth/oauth-client.ts` shows the scope in createAuthUrl()
2. `npm ls googleapis` shows googleapis installed
3. `npm ls gmail-api-parse-message` shows gmail-api-parse-message installed
4. `npm run build` completes without errors (TypeScript compiles)
  </verify>
  <done>
OAuth createAuthUrl() includes gmail.readonly scope. googleapis and gmail-api-parse-message packages installed and visible in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Gmail TypeScript Types</name>
  <files>src/gmail/types.ts</files>
  <action>
Create `src/gmail/types.ts` with TypeScript interfaces for Gmail MCP tool responses:

```typescript
/**
 * Gmail API response types for MCP tools
 */

/** Summary of a Gmail message (used in search/list results) */
export interface GmailMessageSummary {
  id: string;
  threadId: string;
  subject: string;
  from: string;
  to: string;
  date: string;
  snippet: string;
  labelIds: string[];
}

/** Full Gmail message with body content (used in get result) */
export interface GmailMessage extends GmailMessageSummary {
  textBody: string | null;
  htmlBody: string | null;
  attachments: GmailAttachment[];
}

/** Attachment metadata (body content not included - too large) */
export interface GmailAttachment {
  filename: string;
  mimeType: string;
  size: number;
  attachmentId: string;
}

/** Search/List result with pagination */
export interface GmailSearchResult {
  messages: GmailMessageSummary[];
  nextPageToken: string | null;
  resultSizeEstimate: number;
}

/** Full message result */
export interface GmailGetResult {
  message: GmailMessage;
}

/** Error response for Gmail tools */
export interface GmailErrorResult {
  error: string;
  code: number;
  message: string;
}
```

Create the `src/gmail/` directory if it doesn't exist.

**Design notes:**
- GmailMessageSummary is lightweight for list/search (no body)
- GmailMessage includes body for get operations
- Attachments include metadata only (not content) to avoid large responses
- All types serializable to JSON for MCP text responses
  </action>
  <verify>
1. `ls src/gmail/types.ts` confirms file exists
2. `npm run build` compiles without TypeScript errors
3. `grep -c "export interface" src/gmail/types.ts` shows 6 interfaces exported
  </verify>
  <done>
src/gmail/types.ts exists with GmailMessageSummary, GmailMessage, GmailAttachment, GmailSearchResult, GmailGetResult, and GmailErrorResult interfaces. TypeScript compiles successfully.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. OAuth scope verification:
   ```bash
   grep "gmail.readonly" src/auth/oauth-client.ts
   ```
   Expected: Line showing scope string includes gmail.readonly

2. Dependencies installed:
   ```bash
   npm ls googleapis gmail-api-parse-message
   ```
   Expected: Both packages listed with versions

3. Types compile:
   ```bash
   npm run build
   ```
   Expected: Build succeeds, dist/gmail/types.js created

4. Project structure:
   ```bash
   ls -la src/gmail/
   ```
   Expected: types.ts exists
</verification>

<success_criteria>
- OAuth scope includes `https://www.googleapis.com/auth/gmail.readonly`
- googleapis package at version 15.0.0+ installed
- gmail-api-parse-message package installed
- src/gmail/types.ts exports 6 TypeScript interfaces
- `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-gmail-integration/03-01-SUMMARY.md`
</output>
