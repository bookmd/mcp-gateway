---
phase: 04-calendar-drive-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/drive/types.ts
  - src/drive/client.ts
  - src/drive/parsers.ts
  - src/drive/handlers.ts
  - src/mcp/handlers.ts
autonomous: false

must_haves:
  truths:
    - "User can search Drive files by name or content"
    - "User can list files in a folder"
    - "User can read text content from files"
    - "Google Workspace docs (Docs/Sheets) export to plain text"
  artifacts:
    - path: "src/drive/types.ts"
      provides: "DriveFileSummary, DriveFileContent, DriveSearchResult interfaces"
      min_lines: 25
    - path: "src/drive/client.ts"
      provides: "createDriveClient factory"
      exports: ["createDriveClient"]
    - path: "src/drive/parsers.ts"
      provides: "parseFileMetadata, getExportMimeType functions"
      exports: ["parseFileMetadata", "getExportMimeType"]
    - path: "src/drive/handlers.ts"
      provides: "drive_search, drive_list, drive_get_content MCP tools"
      exports: ["registerDriveHandlers"]
  key_links:
    - from: "src/drive/handlers.ts"
      to: "src/drive/client.ts"
      via: "createDriveClient import"
      pattern: "import.*createDriveClient.*from.*client"
    - from: "src/mcp/handlers.ts"
      to: "src/drive/handlers.ts"
      via: "registerDriveHandlers import and call"
      pattern: "registerDriveHandlers\\(server\\)"
---

<objective>
Implement Drive MCP tools (search, list, read content) and verify end-to-end Calendar and Drive integration.

Purpose: Enable Cursor users to search, browse, and read Google Drive files, satisfying DRIVE-01, DRIVE-02, and DRIVE-03 requirements. Complete Phase 4 with E2E verification.

Output: Working drive_search, drive_list, drive_get_content MCP tools plus verified Calendar integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-calendar-drive-integration/04-RESEARCH.md
@.planning/phases/04-calendar-drive-integration/04-01-SUMMARY.md

# Reference patterns
@src/gmail/handlers.ts
@src/calendar/handlers.ts
@src/mcp/handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drive module foundation (types, client, parsers)</name>
  <files>src/drive/types.ts, src/drive/client.ts, src/drive/parsers.ts</files>
  <action>
Create src/drive/ directory and three files following the established module pattern.

**src/drive/types.ts:**
Define TypeScript interfaces:
- DriveFileSummary: id, name, mimeType, size (optional number), modifiedTime (ISO string), webViewLink, parents (optional string array)
- DriveFileContent extends DriveFileSummary: content (nullable string), exportFormat (optional string - MIME type used for export)
- DriveSearchResult: files array, nextPageToken (nullable)
- DriveListResult: files array, nextPageToken (nullable)
- DriveGetResult: file object (DriveFileContent)
- DriveErrorResult: error, code, message

**src/drive/client.ts:**
Create client factory following Calendar/Gmail pattern:
```typescript
import { google, drive_v3 } from 'googleapis';
import type { UserContext } from '../auth/middleware.js';

export function createDriveClient(userContext: UserContext): drive_v3.Drive {
  const oauth2Client = new google.auth.OAuth2(
    process.env.GOOGLE_CLIENT_ID,
    process.env.GOOGLE_CLIENT_SECRET,
    process.env.GOOGLE_REDIRECT_URI
  );
  oauth2Client.setCredentials({ access_token: userContext.accessToken });
  return google.drive({ version: 'v3', auth: oauth2Client });
}
```

**src/drive/parsers.ts:**
Create parser and helper functions:

1. parseFileMetadata(file: drive_v3.Schema$File): DriveFileSummary
   - Map all fields with proper defaults
   - Convert size string to number if present

2. getExportMimeType(googleMimeType: string): string
   - Map Google Workspace MIME types to export formats:
     - application/vnd.google-apps.document -> text/plain
     - application/vnd.google-apps.spreadsheet -> text/csv
     - application/vnd.google-apps.presentation -> text/plain
   - Return 'text/plain' as default for other Google types

3. isGoogleWorkspaceFile(mimeType: string): boolean
   - Return true if mimeType starts with 'application/vnd.google-apps.'

4. isTextFile(mimeType: string): boolean
   - Return true for text/*, application/json, application/javascript, application/xml, etc.
   - Used to determine if file content can be read as text
  </action>
  <verify>npx tsc --noEmit 2>&1 | head -20</verify>
  <done>Drive module compiles with types.ts, client.ts, parsers.ts files</done>
</task>

<task type="auto">
  <name>Task 2: Create Drive MCP handlers and register</name>
  <files>src/drive/handlers.ts, src/mcp/handlers.ts</files>
  <action>
**src/drive/handlers.ts:**
Create MCP tool handlers following established pattern:

1. Import getUserContext helper pattern (or define locally)
2. Create handleDriveError function:
   - 401: token_expired
   - 403 with rate/quota: rate_limited
   - 403 otherwise: insufficient_scope
   - 404: file_not_found
   - Default: drive_api_error

3. Export registerDriveHandlers(server: McpServer): void

4. Register drive_search tool:
   - Description: "Search Drive files by name or content using query syntax (e.g., \"name contains 'report'\", \"fullText contains 'quarterly'\")"
   - inputSchema with Zod:
     - query: z.string() - Search query (name contains, fullText contains, mimeType, etc.)
     - maxResults: z.number().min(1).max(50).optional() - default 10
     - pageToken: z.string().optional()
   - Handler:
     - Create drive client
     - Call drive.files.list with:
       - q: `trashed=false and ${args.query}` (ALWAYS add trashed=false)
       - fields: 'nextPageToken, files(id, name, mimeType, size, modifiedTime, webViewLink, parents)'
       - pageSize: bounded 1-50
       - pageToken if provided
     - Map through parseFileMetadata
     - Return DriveSearchResult

5. Register drive_list tool:
   - Description: "List files in a folder (use 'root' for My Drive root folder)"
   - inputSchema:
     - folderId: z.string().optional() - Folder ID, default 'root'
     - maxResults: z.number().min(1).max(50).optional() - default 10
     - pageToken: z.string().optional()
   - Handler:
     - Create drive client
     - Build query: `trashed=false and '${folderId || 'root'}' in parents`
     - Call drive.files.list with fields and pagination
     - Return DriveListResult

6. Register drive_get_content tool:
   - Description: "Read file content (text-based files only). Google Docs/Sheets are exported to plain text/CSV."
   - inputSchema:
     - fileId: z.string() - File ID
   - Handler:
     - Create drive client
     - First get file metadata: drive.files.get({ fileId, fields: 'id, name, mimeType, size, modifiedTime, webViewLink' })
     - Check if Google Workspace file (mimeType starts with vnd.google-apps):
       - YES: Use files.export with getExportMimeType, responseType: 'stream'
       - NO: Check if text file, then use files.get with alt: 'media', responseType: 'stream'
     - Collect stream chunks to Buffer, convert to UTF-8 string
     - Return DriveGetResult with content
     - For non-text binary files: return content: null with message in error explaining file type not supported

NOTE: Use async iteration (for await...of) to collect stream chunks per RESEARCH.md example.

7. Log registration: console.log('[MCP] Drive handlers registered: drive_search, drive_list, drive_get_content')

**src/mcp/handlers.ts:**
Add import and registration:
```typescript
import { registerDriveHandlers } from '../drive/handlers.js';
```
Call registerDriveHandlers(server) after registerCalendarHandlers
Update console.log to include all tools
  </action>
  <verify>npx tsc --noEmit && grep -q "registerDriveHandlers" src/mcp/handlers.ts && echo "Drive handlers integrated"</verify>
  <done>drive_search, drive_list, drive_get_content MCP tools registered and TypeScript compiles</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Calendar and Drive MCP integration:
- OAuth flow with calendar.readonly and drive.readonly scopes
- Calendar tools: calendar_list_events, calendar_get_event
- Drive tools: drive_search, drive_list, drive_get_content
  </what-built>
  <how-to-verify>
1. Start the server: `npm run dev`

2. Open browser and authenticate at http://localhost:3000/auth/login
   - You should see consent screen requesting Calendar AND Drive permissions (in addition to Gmail)
   - Complete authentication

3. Connect MCP client (e.g., Cursor or test with curl to SSE endpoint)

4. Test Calendar tools:
   - Call calendar_list_events with no parameters (should return upcoming 7 days)
   - Note an event ID from the list
   - Call calendar_get_event with that eventId (should return full details with attendees if any)

5. Test Drive tools:
   - Call drive_list with no parameters (should list root folder files)
   - Call drive_search with query: "name contains 'test'" or similar
   - Note a text file ID (or Google Doc ID)
   - Call drive_get_content with that fileId (should return file content)

Expected results:
- Calendar lists events with correct date/time, summary, status
- Calendar event details include location, description, attendees (if event has them)
- Drive lists files with name, mimeType, modifiedTime
- Drive search returns matching files
- Drive get content returns text for Docs (exported) and regular text files
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Drive module exists with all 4 files (types, client, parsers, handlers)
3. MCP handlers.ts imports and registers both calendar and drive handlers
4. Server starts without errors: `npm run dev`
5. Human verification confirms E2E functionality for Calendar and Drive
</verification>

<success_criteria>
- drive_search tool returns files matching query
- drive_list tool returns files in specified folder
- drive_get_content tool returns text content from files
- Google Docs export to plain text works
- Calendar tools verified working (from Plan 04-01)
- All 5 Phase 4 requirements implemented (CAL-01, CAL-02, DRIVE-01, DRIVE-02, DRIVE-03)
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-drive-integration/04-02-SUMMARY.md`
</output>
