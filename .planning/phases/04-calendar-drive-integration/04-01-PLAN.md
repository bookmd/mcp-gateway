---
phase: 04-calendar-drive-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth/oauth-client.ts
  - src/calendar/types.ts
  - src/calendar/client.ts
  - src/calendar/parsers.ts
  - src/calendar/handlers.ts
  - src/mcp/handlers.ts
autonomous: true

must_haves:
  truths:
    - "User can list upcoming calendar events within date range"
    - "User can read event details including attendees, location, description"
    - "OAuth flow requests Calendar and Drive readonly scopes"
  artifacts:
    - path: "src/auth/oauth-client.ts"
      provides: "OAuth scopes for Calendar and Drive"
      contains: "calendar.readonly"
    - path: "src/calendar/types.ts"
      provides: "CalendarEventSummary, CalendarEvent, CalendarAttendee interfaces"
      min_lines: 30
    - path: "src/calendar/client.ts"
      provides: "createCalendarClient factory"
      exports: ["createCalendarClient"]
    - path: "src/calendar/parsers.ts"
      provides: "parseEventSummary, parseFullEvent functions"
      exports: ["parseEventSummary", "parseFullEvent"]
    - path: "src/calendar/handlers.ts"
      provides: "calendar_list_events, calendar_get_event MCP tools"
      exports: ["registerCalendarHandlers"]
  key_links:
    - from: "src/calendar/handlers.ts"
      to: "src/calendar/client.ts"
      via: "createCalendarClient import"
      pattern: "import.*createCalendarClient.*from.*client"
    - from: "src/mcp/handlers.ts"
      to: "src/calendar/handlers.ts"
      via: "registerCalendarHandlers import and call"
      pattern: "registerCalendarHandlers\\(server\\)"
---

<objective>
Add Calendar readonly OAuth scope and implement Calendar MCP tools (list events, get event details).

Purpose: Enable Cursor users to access their Google Calendar events, satisfying CAL-01 and CAL-02 requirements.

Output: Working calendar_list_events and calendar_get_event MCP tools following Gmail module pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-calendar-drive-integration/04-RESEARCH.md

# Gmail module as reference pattern
@src/gmail/types.ts
@src/gmail/client.ts
@src/gmail/parsers.ts
@src/gmail/handlers.ts
@src/mcp/handlers.ts
@src/auth/oauth-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Calendar and Drive OAuth scopes</name>
  <files>src/auth/oauth-client.ts</files>
  <action>
Modify the scope string in createAuthUrl() function to add Calendar and Drive readonly scopes.

Current scope:
```
'openid email profile https://www.googleapis.com/auth/gmail.readonly'
```

New scope:
```
'openid email profile https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/drive.readonly'
```

This is a single-line change. Do NOT modify any other part of the OAuth flow.

NOTE: Users will need to re-authenticate after this change to grant the new permissions.
  </action>
  <verify>grep -q "calendar.readonly" src/auth/oauth-client.ts && grep -q "drive.readonly" src/auth/oauth-client.ts && echo "Scopes added"</verify>
  <done>OAuth flow requests calendar.readonly and drive.readonly scopes alongside existing gmail.readonly</done>
</task>

<task type="auto">
  <name>Task 2: Create Calendar module foundation (types, client, parsers)</name>
  <files>src/calendar/types.ts, src/calendar/client.ts, src/calendar/parsers.ts</files>
  <action>
Create src/calendar/ directory and three files following the Gmail module pattern exactly.

**src/calendar/types.ts:**
Define TypeScript interfaces matching RESEARCH.md patterns:
- CalendarEventSummary: id, summary, start (ISO string), end (ISO string), status, htmlLink
- CalendarEvent extends CalendarEventSummary: description (nullable), location (nullable), attendees array, organizer, recurringEventId (optional)
- CalendarAttendee: email, displayName (optional), responseStatus (needsAction|declined|tentative|accepted), optional boolean
- CalendarOrganizer: email, displayName (optional), self boolean
- CalendarListResult: events array, nextPageToken (nullable)
- CalendarGetResult: event object
- CalendarErrorResult: error, code, message

**src/calendar/client.ts:**
Create client factory following Gmail pattern:
```typescript
import { google, calendar_v3 } from 'googleapis';
import type { UserContext } from '../auth/middleware.js';

export function createCalendarClient(userContext: UserContext): calendar_v3.Calendar {
  const oauth2Client = new google.auth.OAuth2(
    process.env.GOOGLE_CLIENT_ID,
    process.env.GOOGLE_CLIENT_SECRET,
    process.env.GOOGLE_REDIRECT_URI
  );
  oauth2Client.setCredentials({ access_token: userContext.accessToken });
  return google.calendar({ version: 'v3', auth: oauth2Client });
}
```

**src/calendar/parsers.ts:**
Create parser functions:
- parseEventSummary(event: calendar_v3.Schema$Event): CalendarEventSummary
  - Handle all-day events (use date) vs timed events (use dateTime)
  - Default empty strings for missing fields
- parseFullEvent(event: calendar_v3.Schema$Event): CalendarEvent
  - Reuse parseEventSummary for base fields
  - Map attendees array with proper responseStatus typing
  - Include organizer info
  </action>
  <verify>npx tsc --noEmit 2>&1 | head -20</verify>
  <done>Calendar module compiles with types.ts, client.ts, parsers.ts files</done>
</task>

<task type="auto">
  <name>Task 3: Create Calendar MCP handlers and register</name>
  <files>src/calendar/handlers.ts, src/mcp/handlers.ts</files>
  <action>
**src/calendar/handlers.ts:**
Create MCP tool handlers following Gmail handlers.ts pattern exactly:

1. Import getUserContext helper pattern (or define locally)
2. Create handleCalendarError function mirroring Gmail error handler:
   - 401: token_expired -> re-authenticate
   - 403 with rate/quota: rate_limited
   - 403 otherwise: insufficient_scope
   - Default: calendar_api_error

3. Export registerCalendarHandlers(server: McpServer): void

4. Register calendar_list_events tool:
   - Description: "List upcoming calendar events within specified date range"
   - inputSchema with Zod:
     - timeMin: z.string().optional() - Start datetime ISO 8601, default now
     - timeMax: z.string().optional() - End datetime ISO 8601, default 7 days from now
     - maxResults: z.number().min(1).max(50).optional() - default 10
     - pageToken: z.string().optional()
   - Handler:
     - Extract userContext, return error if missing
     - Create calendar client
     - Call calendar.events.list with:
       - calendarId: 'primary'
       - timeMin: args.timeMin || new Date().toISOString()
       - timeMax: args.timeMax || 7 days from now
       - maxResults: bounded to 1-50
       - singleEvents: true (CRITICAL - expand recurring events)
       - orderBy: 'startTime' (required when singleEvents=true)
       - pageToken if provided
     - Map results through parseEventSummary
     - Return CalendarListResult with events and nextPageToken

5. Register calendar_get_event tool:
   - Description: "Get full event details including attendees, location, and description"
   - inputSchema: eventId: z.string() required
   - Handler:
     - Extract userContext, return error if missing
     - Create calendar client
     - Call calendar.events.get with calendarId: 'primary', eventId
     - Parse with parseFullEvent
     - Return CalendarGetResult

6. Log registration: console.log('[MCP] Calendar handlers registered: calendar_list_events, calendar_get_event')

**src/mcp/handlers.ts:**
Add import and registration:
```typescript
import { registerCalendarHandlers } from '../calendar/handlers.js';
```
Call registerCalendarHandlers(server) after registerGmailHandlers
Update console.log to include calendar tools
  </action>
  <verify>npx tsc --noEmit && grep -q "registerCalendarHandlers" src/mcp/handlers.ts && echo "Calendar handlers integrated"</verify>
  <done>calendar_list_events and calendar_get_event MCP tools registered and TypeScript compiles</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. OAuth scopes include calendar.readonly and drive.readonly
3. Calendar module exists with all 4 files (types, client, parsers, handlers)
4. MCP handlers.ts imports and registers calendar handlers
5. Server starts without errors: `npm run dev` (Ctrl+C to stop)
</verification>

<success_criteria>
- OAuth flow requests calendar.readonly scope (visible in login URL)
- calendar_list_events tool registered (visible in MCP tools list)
- calendar_get_event tool registered (visible in MCP tools list)
- TypeScript compilation passes
- CAL-01 and CAL-02 requirements infrastructure complete (E2E testing in Plan 04-02)
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-drive-integration/04-01-SUMMARY.md`
</output>
