---
phase: 05-docs-sheets-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth/oauth-client.ts
  - src/docs/types.ts
  - src/docs/client.ts
  - src/docs/parsers.ts
  - src/docs/handlers.ts
  - src/mcp/handlers.ts
autonomous: true

must_haves:
  truths:
    - "User can retrieve text content from a Google Doc by document ID"
    - "Docs tool returns structured content including paragraphs from all tabs"
    - "User receives clear error when document not found or unauthorized"
  artifacts:
    - path: "src/auth/oauth-client.ts"
      provides: "OAuth scopes for Docs and Sheets APIs"
      contains: "documents.readonly"
    - path: "src/docs/types.ts"
      provides: "DocsDocument, DocsContent, DocsGetResult interfaces"
      min_lines: 20
    - path: "src/docs/client.ts"
      provides: "createDocsClient factory function"
      exports: ["createDocsClient"]
    - path: "src/docs/parsers.ts"
      provides: "extractText, parseDocument functions"
      exports: ["extractText", "parseDocument"]
    - path: "src/docs/handlers.ts"
      provides: "docs_get_content MCP tool registration"
      exports: ["registerDocsHandlers"]
  key_links:
    - from: "src/docs/handlers.ts"
      to: "src/docs/client.ts"
      via: "createDocsClient import"
      pattern: "import.*createDocsClient.*from.*client"
    - from: "src/docs/handlers.ts"
      to: "src/docs/parsers.ts"
      via: "extractText import"
      pattern: "import.*extractText.*from.*parsers"
    - from: "src/mcp/handlers.ts"
      to: "src/docs/handlers.ts"
      via: "registerDocsHandlers call"
      pattern: "registerDocsHandlers\\(server\\)"
---

<objective>
Add OAuth scopes for Google Docs and Sheets APIs, then implement complete Google Docs integration module with MCP tool.

Purpose: Enable Cursor users to read structured content from Google Docs documents directly through the MCP gateway, going beyond Drive's plain text export to preserve document structure.
Output: OAuth scopes updated (both Docs + Sheets for single re-auth), docs/ module with types/client/parsers/handlers, docs_get_content MCP tool registered.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-docs-sheets-integration/05-RESEARCH.md
@src/auth/oauth-client.ts
@src/drive/types.ts
@src/drive/client.ts
@src/drive/parsers.ts
@src/drive/handlers.ts
@src/mcp/handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OAuth scopes and create Docs module foundation</name>
  <files>
    src/auth/oauth-client.ts
    src/docs/types.ts
    src/docs/client.ts
  </files>
  <action>
1. Update src/auth/oauth-client.ts - Add both Docs and Sheets scopes to the OAuth scope string:
   - Add: https://www.googleapis.com/auth/documents.readonly
   - Add: https://www.googleapis.com/auth/spreadsheets.readonly
   - Keep existing scopes (openid, email, profile, gmail.readonly, calendar.readonly, drive.readonly)
   - NOTE: Users will need to re-authenticate at /auth/login after this change

2. Create src/docs/types.ts following Drive pattern:
   - DocsDocument interface: id, title, documentId
   - DocsContent interface: text (extracted), tabs (number of tabs processed)
   - DocsGetResult interface: document (DocsDocument), content (DocsContent)
   - DocsErrorResult interface: error, code, message

3. Create src/docs/client.ts following Drive pattern:
   - Import { google, docs_v1 } from 'googleapis'
   - Import UserContext from '../auth/middleware.js'
   - createDocsClient(userContext: UserContext): docs_v1.Docs function
   - Create OAuth2Client with env vars (CLIENT_ID, CLIENT_SECRET, REDIRECT_URI)
   - Set credentials with userContext.accessToken
   - Return google.docs({ version: 'v1', auth: oauth2Client })
  </action>
  <verify>
    - `grep -q "documents.readonly" src/auth/oauth-client.ts` returns 0
    - `grep -q "spreadsheets.readonly" src/auth/oauth-client.ts` returns 0
    - `npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    OAuth client includes documents.readonly and spreadsheets.readonly scopes. Docs types and client factory exist and compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Docs parsers and MCP tool handler</name>
  <files>
    src/docs/parsers.ts
    src/docs/handlers.ts
    src/mcp/handlers.ts
  </files>
  <action>
1. Create src/docs/parsers.ts with recursive text extraction (CRITICAL: handle tabs structure):
   - Import { docs_v1 } from 'googleapis'
   - extractText(doc: docs_v1.Schema$Document): string function
     - Iterate through doc.tabs array (not doc.body directly!)
     - For each tab, extract tab.documentTab.body.content
     - Call extractElementText for each structural element
     - Join all text with empty string
   - extractElementText(element: docs_v1.Schema$StructuralElement): string helper
     - Handle element.paragraph: extract textRun.content from elements
     - Handle element.table: iterate tableRows/tableCells/content recursively
     - Return empty string for other element types
   - parseDocument(doc: docs_v1.Schema$Document): DocsContent function
     - Call extractText to get full text
     - Count tabs: (doc.tabs || []).length
     - Return { text, tabs }

2. Create src/docs/handlers.ts following Drive pattern:
   - Import McpServer, z, UserContext, getUserContextBySessionId
   - Import createDocsClient from './client.js'
   - Import parseDocument, extractText from './parsers.js'
   - Import DocsGetResult from './types.js'

   - getUserContext(extra: any) helper (copy from Drive)

   - handleDocsError(error: any) function:
     - 401: token_expired, re-authenticate message
     - 403: Check for rate/quota in message -> rate_limited, else insufficient_scope
     - 404: document_not_found, "Document not found or you do not have permission"
     - Default: docs_api_error with code and message

   - registerDocsHandlers(server: McpServer): void function
     - Register 'docs_get_content' tool:
       - description: 'Read text content from a Google Doc including content from all document tabs'
       - inputSchema: { documentId: z.string().describe('Document ID (from URL or Drive)') }
       - Handler:
         1. Get userContext, return error if missing
         2. Create docs client with createDocsClient(userContext)
         3. Call docs.documents.get({ documentId, includeTabsContent: true })
         4. Parse with parseDocument(result.data)
         5. Build DocsGetResult with document info and content
         6. Return JSON stringified result
         7. Catch errors with handleDocsError
     - Log registration: console.log('[MCP] Docs handlers registered: docs_get_content')

3. Update src/mcp/handlers.ts:
   - Add import: import { registerDocsHandlers } from '../docs/handlers.js'
   - Add call after registerDriveHandlers: registerDocsHandlers(server)
   - Update log message to include docs_get_content
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep -q "registerDocsHandlers" src/mcp/handlers.ts` returns 0
    - `grep -q "docs_get_content" src/docs/handlers.ts` returns 0
  </verify>
  <done>
    Docs parsers handle document tabs structure recursively. docs_get_content MCP tool registered. User can call docs_get_content with documentId to retrieve document text.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. `npm run dev` - Server starts without errors
3. OAuth scopes include documents.readonly and spreadsheets.readonly
4. MCP handler registration log shows docs_get_content
</verification>

<success_criteria>
- OAuth client updated with both Docs and Sheets readonly scopes
- src/docs/ module exists with types.ts, client.ts, parsers.ts, handlers.ts
- docs_get_content MCP tool registered and ready for use
- Parsers correctly handle document tabs structure (iterate doc.tabs, not doc.body)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-docs-sheets-integration/05-01-SUMMARY.md`
</output>
