---
phase: 05-docs-sheets-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/sheets/types.ts
  - src/sheets/client.ts
  - src/sheets/parsers.ts
  - src/sheets/handlers.ts
  - src/mcp/handlers.ts
autonomous: true

must_haves:
  truths:
    - "User can retrieve cell values from a Google Sheet by spreadsheet ID and range"
    - "User can get spreadsheet metadata including sheet names"
    - "Sheets tools return structured data with normalized rows"
    - "User receives clear error when spreadsheet not found or unauthorized"
  artifacts:
    - path: "src/sheets/types.ts"
      provides: "SheetsData, SheetsMetadata, SheetsGetValuesResult, SheetsGetMetadataResult interfaces"
      min_lines: 25
    - path: "src/sheets/client.ts"
      provides: "createSheetsClient factory function"
      exports: ["createSheetsClient"]
    - path: "src/sheets/parsers.ts"
      provides: "parseValueRange, parseSpreadsheetMetadata functions"
      exports: ["parseValueRange", "parseSpreadsheetMetadata"]
    - path: "src/sheets/handlers.ts"
      provides: "sheets_get_values, sheets_get_metadata MCP tool registrations"
      exports: ["registerSheetsHandlers"]
  key_links:
    - from: "src/sheets/handlers.ts"
      to: "src/sheets/client.ts"
      via: "createSheetsClient import"
      pattern: "import.*createSheetsClient.*from.*client"
    - from: "src/sheets/handlers.ts"
      to: "src/sheets/parsers.ts"
      via: "parseValueRange import"
      pattern: "import.*parseValueRange.*from.*parsers"
    - from: "src/mcp/handlers.ts"
      to: "src/sheets/handlers.ts"
      via: "registerSheetsHandlers call"
      pattern: "registerSheetsHandlers\\(server\\)"
---

<objective>
Implement complete Google Sheets integration module with MCP tools for reading cell values and spreadsheet metadata.

Purpose: Enable Cursor users to read structured data from Google Sheets spreadsheets, providing cell values with proper normalization for sparse data and metadata about sheets in a workbook.
Output: sheets/ module with types/client/parsers/handlers, sheets_get_values and sheets_get_metadata MCP tools registered.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-docs-sheets-integration/05-RESEARCH.md
@.planning/phases/05-docs-sheets-integration/05-01-SUMMARY.md
@src/drive/types.ts
@src/drive/client.ts
@src/drive/parsers.ts
@src/drive/handlers.ts
@src/mcp/handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sheets module foundation (types and client)</name>
  <files>
    src/sheets/types.ts
    src/sheets/client.ts
  </files>
  <action>
1. Create src/sheets/types.ts following Drive pattern:
   - SheetsData interface:
     - range: string (actual range returned, e.g., "Sheet1!A1:D5")
     - rows: any[][] (normalized 2D array of cell values)
     - rowCount: number
     - columnCount: number
     - isEmpty: boolean

   - SheetInfo interface:
     - sheetId: number
     - title: string
     - index: number
     - rowCount: number
     - columnCount: number

   - SheetsMetadata interface:
     - spreadsheetId: string
     - title: string
     - spreadsheetUrl: string
     - sheets: SheetInfo[]

   - SheetsGetValuesResult interface:
     - data: SheetsData

   - SheetsGetMetadataResult interface:
     - metadata: SheetsMetadata

   - SheetsErrorResult interface:
     - error: string
     - code: number
     - message: string

2. Create src/sheets/client.ts following Drive pattern:
   - Import { google, sheets_v4 } from 'googleapis'
   - Import UserContext from '../auth/middleware.js'
   - createSheetsClient(userContext: UserContext): sheets_v4.Sheets function
   - Create OAuth2Client with env vars (CLIENT_ID, CLIENT_SECRET, REDIRECT_URI)
   - Set credentials with userContext.accessToken
   - Return google.sheets({ version: 'v4', auth: oauth2Client })
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `ls src/sheets/types.ts src/sheets/client.ts` shows both files exist
  </verify>
  <done>
    Sheets types defined including normalized row structure. Client factory creates per-user authenticated Sheets API client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Sheets parsers and MCP tool handlers</name>
  <files>
    src/sheets/parsers.ts
    src/sheets/handlers.ts
    src/mcp/handlers.ts
  </files>
  <action>
1. Create src/sheets/parsers.ts with data normalization (CRITICAL: handle sparse data):
   - Import { sheets_v4 } from 'googleapis'
   - Import { SheetsData, SheetInfo, SheetsMetadata } from './types.js'

   - parseValueRange(result: sheets_v4.Schema$ValueRange): SheetsData function
     - Get range from result.range || 'Unknown'
     - Get values from result.values || []
     - If empty: return { range, rows: [], rowCount: 0, columnCount: 0, isEmpty: true }
     - Calculate maxCols = Math.max(...values.map(row => row.length)) or 0 if empty
     - Normalize rows: pad each row to maxCols with null for sparse data
     - Return { range, rows: normalizedRows, rowCount, columnCount: maxCols, isEmpty: false }

   - parseSheetProperties(sheet: sheets_v4.Schema$Sheet): SheetInfo function
     - Extract from sheet.properties: sheetId, title, index
     - Extract gridProperties: rowCount, columnCount (default 0 if missing)
     - Return SheetInfo object

   - parseSpreadsheetMetadata(spreadsheet: sheets_v4.Schema$Spreadsheet): SheetsMetadata function
     - Extract: spreadsheetId, properties.title, spreadsheetUrl
     - Map sheets array through parseSheetProperties
     - Return SheetsMetadata object

2. Create src/sheets/handlers.ts following Drive pattern:
   - Import McpServer, z, UserContext, getUserContextBySessionId
   - Import createSheetsClient from './client.js'
   - Import parseValueRange, parseSpreadsheetMetadata from './parsers.js'
   - Import SheetsGetValuesResult, SheetsGetMetadataResult from './types.js'

   - getUserContext(extra: any) helper (copy from Drive)

   - handleSheetsError(error: any) function:
     - 401: token_expired, re-authenticate message
     - 403: Check for rate/quota -> rate_limited (60 reads/min per user limit), else insufficient_scope
     - 404: spreadsheet_not_found, "Spreadsheet not found or you do not have permission"
     - Default: sheets_api_error with code and message

   - registerSheetsHandlers(server: McpServer): void function
     - Register 'sheets_get_values' tool:
       - description: 'Read cell values from a Google Sheet range using A1 notation (e.g., "Sheet1!A1:D10")'
       - inputSchema: {
           spreadsheetId: z.string().describe('Spreadsheet ID (from URL)'),
           range: z.string().describe('Range in A1 notation (e.g., "Sheet1!A1:D10" or "A1:D10" for first sheet)')
         }
       - Handler:
         1. Get userContext, return error if missing
         2. Create sheets client with createSheetsClient(userContext)
         3. Call sheets.spreadsheets.values.get({ spreadsheetId, range })
         4. Parse with parseValueRange(result.data)
         5. Build SheetsGetValuesResult
         6. Return JSON stringified result
         7. Catch errors with handleSheetsError

     - Register 'sheets_get_metadata' tool:
       - description: 'Get spreadsheet metadata including sheet names and dimensions'
       - inputSchema: {
           spreadsheetId: z.string().describe('Spreadsheet ID (from URL)')
         }
       - Handler:
         1. Get userContext, return error if missing
         2. Create sheets client with createSheetsClient(userContext)
         3. Call sheets.spreadsheets.get({ spreadsheetId, includeGridData: false })
         4. Parse with parseSpreadsheetMetadata(result.data)
         5. Build SheetsGetMetadataResult
         6. Return JSON stringified result
         7. Catch errors with handleSheetsError

     - Log registration: console.log('[MCP] Sheets handlers registered: sheets_get_values, sheets_get_metadata')

3. Update src/mcp/handlers.ts:
   - Add import: import { registerSheetsHandlers } from '../sheets/handlers.js'
   - Add call after registerDocsHandlers: registerSheetsHandlers(server)
   - Update log message to include sheets_get_values, sheets_get_metadata
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `grep -q "registerSheetsHandlers" src/mcp/handlers.ts` returns 0
    - `grep -q "sheets_get_values" src/sheets/handlers.ts` returns 0
    - `grep -q "sheets_get_metadata" src/sheets/handlers.ts` returns 0
  </verify>
  <done>
    Sheets parsers handle sparse data with row normalization. sheets_get_values and sheets_get_metadata MCP tools registered. Users can read cell values and spreadsheet structure.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. `npm run dev` - Server starts without errors
3. MCP handler registration log shows sheets_get_values, sheets_get_metadata
4. Total MCP tools: 13 (whoami, test_auth, 3 gmail, 2 calendar, 3 drive, 1 docs, 2 sheets)
</verification>

<success_criteria>
- src/sheets/ module exists with types.ts, client.ts, parsers.ts, handlers.ts
- sheets_get_values MCP tool reads cell data with A1 notation range
- sheets_get_metadata MCP tool returns sheet names and dimensions
- Parsers normalize sparse data (pad rows to max column count)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-docs-sheets-integration/05-02-SUMMARY.md`
</output>
